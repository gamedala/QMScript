[General]
SyntaxVersion=2
BeginHotkey=121
BeginHotkeyMod=0
PauseHotkey=0
PauseHotkeyMod=0
StopHotkey=123
StopHotkeyMod=0
RunOnce=1
EnableWindow=
MacroID=82025f82-927a-4a69-879a-f562f5406275
Description=釣魚
Enable=1
AutoRun=0
[Repeat]
Type=0
Number=1
[SetupUI]
Type=2
QUI=
[Relative]
SetupOCXFile=
[Comment]

[Attachment]
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


[Script]
text = Plugin.File.GetFileLength("c:\dm\光雨驗證.txt")
If text <> 3487 Then 
   	PutAttachment "c:\dm", "光雨驗證.txt"
End If

Dimenv Hwnds
Hwnd = Plugin.Window.Search("Ragnarok")//搜索標題指定句柄  
MyArray = Split(Hwnd, "|")//分割字串
If UBound(MyArray) >= 0 Then
	For i = 0 To UBound(MyArray) - 1
		Hwnds = Clng(MyArray(i))
		BeginThread 釣魚
		Delay 100
	Next  
End If

Sub 釣魚
	dim fish
	Call set_dm
	Delay 100
	Do
		Call 負重檢查
		do While int(Plugin.Memory.Read32Bit(Hwnd, &H00F83AC0)) = 0
    		ret = dm.FindColorEx(250, 130, 770, 570, "ffff55-000005", 1.0, 0)
    		ret = dm.FindNearestPos(ret, 1, 510, 320)
    		If ret<>"" Then 
				arr = Split(ret, ",")
				intX = arr(0)
				intY = arr(1)
       			dm.MoveTo intX, intY
       			dm.LeftClick
	
    		End If
    		dm_ret = dm.FindStr(6, 679, 253, 697, "請結束后再進行", "ffffff-000000", 1.0, intX, intY)
    		If intX > 0 Then 
    			//fish = True
    			Exit do
    		End If
		loop
		Delay 2000
	Loop
End Sub

Function 負重檢查
    最大 = int(Plugin.Memory.Read32Bit(Hwnd, &H011CCEDC))
    最小 = int(Plugin.Memory.Read32Bit(Hwnd, &H011CCEE0))
    負重 = fix((最小 / 最大) * 100)
    If 負重 > 80 Then 
        Do
            If int(Plugin.Memory.Read32Bit(Hwnd, &H00F80558)) <> 0 Then 
                If int(Plugin.Memory.Read32Bit(Hwnd, &H00F8055C)) <> 0 Then
                    dm.KeyPress 40
                    Delay 100
                    dm.KeyPress 40
                    Delay 100
                    dm.KeyPress 40
                    Delay 100
                    Do
                    	dm.KeyPress 13
                    	Delay 100
                    Loop While int(Plugin.Memory.Read32Bit(Hwnd, &H00F80558)) <> 0 OR int(Plugin.Memory.Read32Bit(Hwnd, &H00F8055C)) <> 0
                    Exit Do
                Else 
                    dm.KeyPress 13
                End If
            Else
                dm.KeyDown 120
            End If
        Loop
        Call 存倉()
        Call 關閉倉庫()
        //fish = False
    End If
End Function

Function 存倉()
    Dim Run
    種類 = array("消耗","裝備","其他")
    //Rem 重新開始
    If int(Plugin.Memory.Read32Bit(Hwnd, &H011CCF1C)) <> 0 Then
        Do
            dm_ret = dm.FindStr(0, 0, 1024, 768, "物品欄", "000000-000000", 1, intX, intY)
            If intX > 0 And intY > 0 Then 
                Do
                    dm_ret = dm.FindStr(intX - 12, intY + 20, intX + 1 , intY + 145, 種類(Run), "000000-313131", 1, intX2, intY2)
                    If intX2 > 0 And intY2 > 0 Then 
                        dm.MoveTo intX2, intY2
                        dm.LeftClick
                        Do
                        	dm.MoveTo intX2, intY2
                            dm_ret = dm.FindStr(intX + 25, intY + 25, intX + 65, intY + 55, "無物品", "ced6e6-000001", 1, intX3, intY3)
                            If intX3 < 0 And intY3 < 0 Then 
								dm.MoveTo intX + 40, intY + 45
                                dm.KeyDown 18
                                dm.RightClick
                                dm.KeyUp 18
                            End If
                            //TracePrint intX3& "/" & intY3
                        Loop Until intX3 > 0 And intY3 > 0
                        TracePrint Hwnd & " [" & 種類(Run) & "] 存放完成"
                        Run = Run + 1
                        delay 10
                    End If
                Loop Until Run > 2
            Else 
                dm.KeyDown 18
                dm.KeyPress 69
                dm.KeyUp 18
                //Goto 重新開始
            End If
        Loop Until  intX > 0 And intY > 0
    Else
        TracePrint "[Error] 倉庫未開啟無法存放"
        Delay 1000
    End If
End Function

Function 關閉倉庫()
	倉庫 = int(Plugin.Memory.Read32Bit(Hwnd, &H011CCF1C))
	If 倉庫 > 0 Then 
		dm_ret = dm.FindStr(0, 0, 1024, 768, "個人倉庫", "000000-000000", 1, intX, intY)
		dm_ret = dm.FindStr(intX, intY, intX + 280, intY + 450, "關閉", "000000-000000", 1, intX3, intY3)
		If intX3 > 0 And intY3 > 0 Then 
			dm.MoveTo intX3, intY3
			dm.LeftClick 
            dm.KeyDown 18
            dm.KeyPress 69
            dm.KeyUp 18
			TracePrint "關閉倉庫"
		End If
	Else
		TracePrint "[ERROR] 找不到倉庫關閉"
		Delay 1000
	End If
End Function

Function set_dm()
	Hwnd = Hwnds
	Set dm = createobject("dm.dmsoft")
    base_path = dm.GetBasePath()
    dm_ret = dm.SetPath(base_path)
    dm_ret = dm.SetDict(0, "光雨驗證.txt")
    //Hwnd = Plugin.Window.Find(0, "Ragnarok")
    dm_ret = dm.BindWindow(Hwnd, "gdi", "dx2", "dx", 4)
    TracePrint "Hwnd:" & Hwnd & " dm_ret:" & dm_ret
End Function